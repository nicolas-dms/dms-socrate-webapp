name: Build and Deploy WebApp to Test

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  AZURE_SUBSCRIPTION_ID: dc247650-4ab3-4b8e-bec7-2286ecf3ff7c
  ACR_NAME: exominutesacr
  ACR_LOGIN_SERVER: exominutesacr.azurecr.io
  WEBAPP_IMAGE_NAME: exominutes-webapp

jobs:

  # ----------------------------------------------------------
  #  BUILD & PUSH DOCKER IMAGE
  # ---------------------------------------------------------
  build:
    name: Build & Push WebApp Image
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.tag.outputs.IMAGE_TAG }}
      revision-tag: ${{ steps.tag.outputs.REV_TAG }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ✨ HUMAN READABLE TAG: 20251201-1545-abc1234
      - name: Set image tag (YYYYMMDD-HHMM-SHORTSHA)
        id: tag
        run: |
          SHORT_SHA=$(echo "${GITHUB_SHA}" | cut -c1-7)
          VERSION="$(date +%Y%m%d-%H%M)-${SHORT_SHA}"
          echo "IMAGE_TAG=$VERSION" >> $GITHUB_OUTPUT
          echo "REV_TAG=$VERSION" >> $GITHUB_OUTPUT

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Login to ACR
        run: az acr login --name $ACR_NAME

      - name: Load build args from env/test.env
        id: envfile
        run: |
          # Parse env/test.env — skip comments, blanks, and NEXT_PUBLIC_STRIPE (comes from secret)
          while IFS= read -r line; do
            [[ "$line" =~ ^\s*# ]] && continue
            [[ -z "$line" ]] && continue
            [[ "$line" =~ ^NEXT_PUBLIC_STRIPE ]] && continue
            echo "$line" >> $GITHUB_ENV
          done < env/test.env

      - name: Build & Push WebApp Image (Test)
        run: |
          docker build \
            -t $ACR_LOGIN_SERVER/$WEBAPP_IMAGE_NAME:${{ steps.tag.outputs.IMAGE_TAG }} \
            -t $ACR_LOGIN_SERVER/$WEBAPP_IMAGE_NAME:test \
            --build-arg NEXT_PUBLIC_API_URL=$NEXT_PUBLIC_API_URL \
            --build-arg NEXT_PUBLIC_ENVIRONMENT=$NEXT_PUBLIC_ENVIRONMENT \
            --build-arg NEXT_PUBLIC_DEBUG_MODE=$NEXT_PUBLIC_DEBUG_MODE \
            --build-arg NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=${{ secrets.STRIPE_PUBLISHABLE_KEY_TEST }} \
            --build-arg NEXT_PUBLIC_APP_VERSION=${{ steps.tag.outputs.IMAGE_TAG }} \
            --build-arg NEXT_PUBLIC_BUILD_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ) \
            -f Dockerfile .

          docker push $ACR_LOGIN_SERVER/$WEBAPP_IMAGE_NAME:${{ steps.tag.outputs.IMAGE_TAG }}
          docker push $ACR_LOGIN_SERVER/$WEBAPP_IMAGE_NAME:test

  # ---------------------------------------------------------
  #  DEPLOY TO TEST (AUTOMATIC)
  # ---------------------------------------------------------
  deploy-test:
    name: Deploy WebApp to Test
    runs-on: ubuntu-latest
    needs: build
    environment: test

    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # ✨ readable revision name
      - name: Deploy Test Revision
        run: |
          az containerapp update \
            --name aca-exominutes-webapp-test \
            --resource-group rg-exominute-test \
            --image $ACR_LOGIN_SERVER/$WEBAPP_IMAGE_NAME:${{ needs.build.outputs.image-tag }} \
            --revision-suffix "${{ needs.build.outputs.revision-tag }}"
          echo "Deployed image tag: ${{ needs.build.outputs.image-tag }}"

      - name: Output Test URL
        run: |
          URL=$(az containerapp show \
            --name aca-exominutes-webapp-test \
            --resource-group rg-exominute-test \
            --query properties.configuration.ingress.fqdn -o tsv)
          echo "Test WebApp URL: https://$URL"
          echo "Test Revision: ${{ needs.build.outputs.revision-tag }}"

 